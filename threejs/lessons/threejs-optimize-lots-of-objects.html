<!DOCTYPE html>
<!-- this file is auto-generated from threejs/lessons/threejs-optimize-lots-of-objects.md. Do not edited directly -->
<!--
Copyright 2018, Google Inc.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of Google Inc. nor the names of their
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta property="og:title" content="Three.js Optimize Lots of Objects" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://threejsfundamentals.org/threejs/lessons/resources/threejsfundamentals.jpg" />
<meta property="og:description" content="Optimize by merging Objects" />
<meta property="og:url" content="https://threejsfundamentals.org/threejs/lessons/threejs-optimize-lots-of-objects.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="threejsfundamentals.org" />
<meta name="twitter:title" content="Three.js Optimize Lots of Objects" />
<meta name="twitter:url" content="https://threejsfundamentals.org/threejs/lessons/threejs-optimize-lots-of-objects.html" />
<meta name="twitter:description" content="Optimize by merging Objects" />
<meta name="twitter:image:src" content="https://threejsfundamentals.org/threejs/lessons/resources/threejsfundamentals.jpg" />


<title>Three.js Optimize Lots of Objects</title>
<link href="/threejs/lessons/resources/threejsfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="apple-touch-icon" href="/threejs/lessons/resources/threejsfundamentals-icon.png">
<link rel="icon" href="/threejs/lessons/resources/threejsfundamentals-icon.png">
<link rel="stylesheet" href="/threejs/lessons/resources/lesson.css" />
</head>
<body>
<div class="threejs_navbar">
  <div>
    <select class="language">
    <option value="/threejs/lessons/threejs-optimize-lots-of-objects.html" selected>English</a>
    <option value="/threejs/lessons/ru/threejs-optimize-lots-of-objects.html" >Русский</a>
    <option value="/threejs/lessons/zh_cn/threejs-optimize-lots-of-objects.html" >中文</a>
</select>


    <a href="#toc">Table of Contents</a>
  </div>
</div>
<div class="threejs_header">
  <h1><a href="/">threejsfundamentals.org</a></h1>
</div>


<div class="container">
  <div class="lesson-title">
    <h1>Three.js Optimize Lots of Objects</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>This article is part of a series of articles about three.js. The first article
is <a href="threejs-fundamentals.html">three.js fundamentals</a>. If you haven&#39;t read that
yet and you&#39;re new to three.js you might want to consider starting there. </p>
<p>There are many ways to optimize things for three.js. One way is often referred
to as <em>merging geometry</em>. Every <code>Mesh</code> you create and three.js represents 1 or
more requests by the system to draw something. Drawing 2 things has more
overhead than drawing 1 even if the results are the same so one way to optimize
is to merge meshes.</p>
<p>Let&#39;s show an example of when this is a good solution for an issue. Let&#39;s
re-create the <a href="https://globe.chromeexperiments.com/">WebGL Globe</a>.</p>
<p>The first thing we need to do is get some data. The WebGL Globe said the data
they use comes from <a href="http://sedac.ciesin.columbia.edu/gpw/">SEDAC</a>. Checking out
the site I saw there was <a href="http://sedac.ciesin.columbia.edu/data/set/gpw-v4-basic-demographic-characteristics-rev10">demographic data in a grid
format</a>.
I downloaded the data at 60 minute resolution. Then I took a look at the data</p>
<p>It looks like this</p>
<pre class="prettyprint"><code class="lang-txt"> ncols         360
 nrows         145
 xllcorner     -180
 yllcorner     -60
 cellsize      0.99999999999994
 NODATA_value  -9999
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
 9.241768 8.790958 2.095345 -9999 0.05114867 -9999 -9999 -9999 -9999 -999...
 1.287993 0.4395509 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999...
 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 -9999 ...
</code></pre>
<p>There&#39;s a few lines that are like key/value pairs followed by lines with a value
per grid point, one line for each row of data points.</p>
<p>To make sure we understand the data let&#39;s try to plot it in 2D.</p>
<p>First some code to load the text file</p>
<pre class="prettyprint"><code class="lang-js">async function loadFile(url) {
  const req = await fetch(url);
  return req.text();
}
</code></pre>
<p>The code above returns a <code>Promise</code> with the contents of the file at <code>url</code>;</p>
<p>Then we need some code to parse the file</p>
<pre class="prettyprint"><code class="lang-js">function parseData(text) {
  const data = [];
  const settings = {data};
  let max;
  let min;
  // split into lines
  text.split(&#39;\n&#39;).forEach((line) =&gt; {
    // split the line by whitespace
    const parts = line.trim().split(/\s+/);
    if (parts.length === 2) {
      // only 2 parts, must be a key/value pair
      settings[parts[0]] = parseFloat(parts[1]);
    } else if (parts.length &gt; 2) {
      // more than 2 parts, must be data
      const values = parts.map((v) =&gt; {
        const value = parseFloat(v);
        if (value === settings.NODATA_value) {
          return undefined;
        }
        max = Math.max(max === undefined ? value : max, value);
        min = Math.min(min === undefined ? value : min, value);
        return value;
      });
      data.push(values);
    }
  });
  return Object.assign(settings, {min, max});
}
</code></pre>
<p>The code above returns an object with all the key/value pairs from the file as
well as a <code>data</code> property with all the data in one large array and the <code>min</code> and
<code>max</code> values found in the data.</p>
<p>Then we need some code to draw that data</p>
<pre class="prettyprint"><code class="lang-js">function drawData(file) {
  const {min, max, data} = file;
  const range = max - min;
  const ctx = document.querySelector(&#39;canvas&#39;).getContext(&#39;2d&#39;);
  // make the canvas the same size as the data
  ctx.canvas.width = ncols;
  ctx.canvas.height = nrows;
  // but display it double size so it&#39;s not too small
  ctx.canvas.style.width = px(ncols * 2);
  ctx.canvas.style.height = px(nrows * 2);
  // fill the canvas to dark gray
  ctx.fillStyle = &#39;#444&#39;;
  ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  // draw each data point
  data.forEach((row, latNdx) =&gt; {
    row.forEach((value, lonNdx) =&gt; {
      if (value === undefined) {
        return;
      }
      const amount = (value - min) / range;
      const hue = 1;
      const saturation = 1;
      const lightness = amount;
      ctx.fillStyle = hsl(hue, saturation, lightness);
      ctx.fillRect(lonNdx, latNdx, 1, 1);
    });
  });
}

function px(v) {
  return `${v | 0}px`;
}

function hsl(h, s, l) {
  return `hsl(${h * 360 | 0},${s * 100 | 0}%,${l * 100 | 0}%)`;
}
</code></pre>
<p>And finally gluing it all together</p>
<pre class="prettyprint"><code class="lang-js">loadFile(&#39;resources/data/gpw/gpw-v4-basic-demographic-characteristics-rev10_a000_014_2010_1_deg_asc/gpw_v4_basic_demographic_characteristics_rev10_a000_014mt_2010_cntm_1_deg.asc&#39;)
  .then(parseData)
  .then(drawData);
</code></pre>
<p>Gives us this result</p>
<p><div class="threejs_example_container">
  <div><iframe class="threejs_example" style=" " src="/threejs/resources/editor.html?url=/threejs/lessons/..%2Fgpw-data-viewer.html"></iframe></div>
  <a class="threejs_center" href="/threejs/lessons/../gpw-data-viewer.html" target="_blank">click here to open in a separate window</a>
</div>

</p>
<p>So that seems to work. </p>
<p>Let&#39;s try it in 3D. Starting with the code from <a href="threejs-rendering-on-demand.html">rendering on
demand</a> We&#39;ll make one box per data in the
file.</p>
<p>First let&#39;s make a simple sphere with a texture of the world. Here&#39;s the texture</p>
<div class="threejs_center"><img src="../resources/images/world.jpg" style="width: 600px"></div>

<p>And the code to set it up.</p>
<pre class="prettyprint"><code class="lang-js">{
  const loader = new THREE.TextureLoader();
  const texture = loader.load(&#39;resources/images/world.jpg&#39;, render);
  const geometry = new THREE.SphereBufferGeometry(1, 64, 32);
  const material = new THREE.MeshBasicMaterial({map: texture});
  scene.add(new THREE.Mesh(geometry, material));
}
</code></pre>
<p>Notice the call to <code>render</code> when the texture has finished loading. We need this
because we&#39;re <a href="threejs-rendering-on-demand.html">rendering on demand</a> instead of
continuously so we need to render once when the texture is loaded.</p>
<p>Then we need to change the code that drew a dot per data point above to instead
make a box per data point.</p>
<pre class="prettyprint"><code class="lang-js">function addBoxes(file) {
  const {min, max, data} = file;
  const range = max - min;

  // make one box geometry
  const boxWidth = 1;
  const boxHeight = 1;
  const boxDepth = 1;
  const geometry = new THREE.BoxBufferGeometry(boxWidth, boxHeight, boxDepth);
  // make it so it scales away from the positive Z axis
  geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0, 0, 0.5));

  // these helpers will make it easy to position the boxes
  // We can rotate the lon helper on its Y axis to the longitude
  const lonHelper = new THREE.Object3D();
  scene.add(lonHelper);
  // We rotate the latHelper on its X axis to the latitude
  const latHelper = new THREE.Object3D();
  lonHelper.add(latHelper);
  // The position helper moves the object to the edge of the sphere
  const positionHelper = new THREE.Object3D();
  positionHelper.position.z = 1;
  latHelper.add(positionHelper);

  const lonFudge = Math.PI * .5;
  const latFudge = Math.PI * -0.135;
  data.forEach((row, latNdx) =&gt; {
    row.forEach((value, lonNdx) =&gt; {
      if (value === undefined) {
        return;
      }
      const amount = (value - min) / range;
      const material = new THREE.MeshBasicMaterial();
      const hue = THREE.Math.lerp(0.7, 0.3, amount);
      const saturation = 1;
      const lightness = THREE.Math.lerp(0.1, 1.0, amount);
      material.color.setHSL(hue, saturation, lightness);
      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      // adjust the helpers to point to the latitude and longitude
      lonHelper.rotation.y = THREE.Math.degToRad(lonNdx + file.xllcorner) + lonFudge;
      latHelper.rotation.x = THREE.Math.degToRad(latNdx + file.yllcorner) + latFudge;

      // use the world matrix of the position helper to
      // position this mesh.
      positionHelper.updateWorldMatrix(true, false);
      mesh.applyMatrix(positionHelper.matrixWorld);

      mesh.scale.set(0.005, 0.005, THREE.Math.lerp(0.01, 0.5, amount));
    });
  });
}
</code></pre>
<p>The code is mostly straight forward from our test drawing code. </p>
<p>We make one box and adjust its center so it scales away from positive Z. If we
didn&#39;t do this it would scale from the center but we want them to grow away from the origin.</p>
<div class="spread">
  <div>
    <div data-diagram="scaleCenter" style="height: 250px"></div>
    <div class="code">default</div>
  </div>
  <div>
    <div data-diagram="scalePositiveZ" style="height: 250px"></div>
    <div class="code">adjusted</div>
  </div>
</div>

<p>Of course we could also solve that by parenting the box to more <code>THREE.Object3D</code>
objects like we covered in <a href="threejs-scenegraphs.html">scene graphs</a> but the more
nodes we add to a scene graph the slower it gets.</p>
<p>We also setup this small hierarchy of nodes of <code>lonHelper</code>, <code>latHelper</code>, and
<code>positionHelper</code>. We use these objects to compute a position around the sphere
were to place the box. </p>
<div class="spread">
  <div data-diagram="lonLatPos" style="width: 600px; height: 400px;"></div>
</div>

<p>Above the <span style="color: green;">green bar</span> represents <code>lonHelper</code> and
is used to rotate toward longitude on the equator. The <span style="color: blue;">
blue bar</span> represents <code>latHelper</code> which is used to rotate to a
latitude above or below the equator. The <span style="color: red;">red
sphere</span> represents the offset that that <code>positionHelper</code> provides.</p>
<p>We could do all of the math manually to figure out positions on the globe but
doing it this way leaves most of the math to the library itself so we don&#39;t need
to deal with.</p>
<p>For each data point we create a <code>MeshBasicMaterial</code> and a <code>Mesh</code> and then we ask
for the world matrix of the <code>positionHelper</code> and apply that to the new <code>Mesh</code>.
Finally we scale the mesh at its new position.</p>
<p>Like above, we could also have created a <code>latHelper</code>, <code>lonHelper</code>, and
<code>positionHelper</code> for every new box but that would be even slower.</p>
<p>There are up to 360x145 boxes we&#39;re going to create. That&#39;s up to 52000 boxes.
Because some data points are marked as &quot;NO_DATA&quot; the actual number of boxes
we&#39;re going to create is around 19000. If we added 3 extra helper objects per
box that would be nearly 80000 scene graph nodes that THREE.js would have to
compute positions for. By instead using one set of helpers to just position the
meshes we save around 60000 operations.</p>
<p>A note about <code>lonFudge</code> and <code>latFudge</code>. <code>lonFudge</code> is π/2 which is a quarter of a turn.
That makes sense. It just means the texture or texture coordinates start at a
different offset around the globe. <code>latFudge</code> on the other hand I have no idea
why it needs to be π * -0.135, that&#39;s just an amount that made the boxes line up
with the texture.</p>
<p>The last thing we need to do is call our loader</p>
<pre class="prettyprint"><code>loadFile(&#39;resources/data/gpw/gpw-v4-basic-demographic-characteristics-rev10_a000_014_2010_1_deg_asc/gpw_v4_basic_demographic_characteristics_rev10_a000_014mt_2010_cntm_1_deg.asc&#39;)
  .then(parseData)
-  .then(drawData)
+  .then(addBoxes)
+  .then(render);
</code></pre><p>Once the data has finished loading and parsing then we need to render at least
once since we&#39;re <a href="threejs-rendering-on-demand.html">rendering on demand</a>.</p>
<p><div class="threejs_example_container">
  <div><iframe class="threejs_example" style=" " src="/threejs/resources/editor.html?url=/threejs/lessons/..%2Fthreejs-lots-of-objects-slow.html"></iframe></div>
  <a class="threejs_center" href="/threejs/lessons/../threejs-lots-of-objects-slow.html" target="_blank">click here to open in a separate window</a>
</div>

</p>
<p>If you try to rotate the example above by dragging on the sample you&#39;ll likely
notice it&#39;s slow.</p>
<p>We can check the framerate by <a href="threejs-debugging-javascript.html">opening the
devtools</a> and turning on the browser&#39;s frame
rate meter.</p>
<div class="threejs_center"><img src="resources/images/bring-up-fps-meter.gif"></div>

<p>On my machine I see a framerate under 20fps.</p>
<div class="threejs_center"><img src="resources/images/fps-meter.gif"></div>

<p>That doesn&#39;t feel very good to me and I suspect many people have slower machines
which would make it even worse. We&#39;d better look into optimizing.</p>
<p>For this particular problem we can merge all the boxes into a single geometry.
We&#39;re currently drawing around 19000 boxes. By merging them into a single
geometry we&#39;d remove 18999 operations.</p>
<p>Here&#39;s the new code to merge the boxes into a single geometry.</p>
<pre class="prettyprint"><code class="lang-js">function addBoxes(file) {
  const {min, max, data} = file;
  const range = max - min;

-  // make one box geometry
-  const boxWidth = 1;
-  const boxHeight = 1;
-  const boxDepth = 1;
-  const geometry = new THREE.BoxBufferGeometry(boxWidth, boxHeight, boxDepth);
-  // make it so it scales away from the positive Z axis
-  geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0, 0, 0.5));

  // these helpers will make it easy to position the boxes
  // We can rotate the lon helper on its Y axis to the longitude
  const lonHelper = new THREE.Object3D();
  scene.add(lonHelper);
  // We rotate the latHelper on its X axis to the latitude
  const latHelper = new THREE.Object3D();
  lonHelper.add(latHelper);
  // The position helper moves the object to the edge of the sphere
  const positionHelper = new THREE.Object3D();
  positionHelper.position.z = 1;
  latHelper.add(positionHelper);
+  // Used to move the center of the box so it scales from the position Z axis
+  const originHelper = new THREE.Object3D();
+  originHelper.position.z = 0.5;
+  positionHelper.add(originHelper);

  const lonFudge = Math.PI * .5;
  const latFudge = Math.PI * -0.135;
+  const geometries = [];
  data.forEach((row, latNdx) =&gt; {
    row.forEach((value, lonNdx) =&gt; {
      if (value === undefined) {
        return;
      }
      const amount = (value - min) / range;

-      const material = new THREE.MeshBasicMaterial();
-      const hue = THREE.Math.lerp(0.7, 0.3, amount);
-      const saturation = 1;
-      const lightness = THREE.Math.lerp(0.1, 1.0, amount);
-      material.color.setHSL(hue, saturation, lightness);
-      const mesh = new THREE.Mesh(geometry, material);
-      scene.add(mesh);

+      const boxWidth = 1;
+      const boxHeight = 1;
+      const boxDepth = 1;
+      const geometry = new THREE.BoxBufferGeometry(boxWidth, boxHeight, boxDepth);

      // adjust the helpers to point to the latitude and longitude
      lonHelper.rotation.y = THREE.Math.degToRad(lonNdx + file.xllcorner) + lonFudge;
      latHelper.rotation.x = THREE.Math.degToRad(latNdx + file.yllcorner) + latFudge;

-      // use the world matrix of the position helper to
-      // position this mesh.
-      positionHelper.updateWorldMatrix(true, false);
-      mesh.applyMatrix(positionHelper.matrixWorld);
-
-      mesh.scale.set(0.005, 0.005, THREE.Math.lerp(0.01, 0.5, amount));

+      // use the world matrix of the origin helper to
+      // position this geometry
+      positionHelper.scale.set(0.005, 0.005, THREE.Math.lerp(0.01, 0.5, amount));
+      originHelper.updateWorldMatrix(true, false);
+      geometry.applyMatrix(originHelper.matrixWorld);
+
+      geometries.push(geometry);
    });
  });

+  const mergedGeometry = BufferGeometryUtils.mergeBufferGeometries(
+      geometries, false);
+  const material = new THREE.MeshBasicMaterial({color:&#39;red&#39;});
+  const mesh = new THREE.Mesh(mergedGeometry, material);
+  scene.add(mesh);

}
</code></pre>
<p>Above we removed the code that was changing the box geometry&#39;s center point and
are instead doing it by adding an <code>originHelper</code>. Before we were using the same
geometry 19000 times. This time we are creating new geometry for every single
box and since we are going to use <code>applyMatrix</code> to move the vertices of each box
geometry we might as well do it once instead of twice.</p>
<p>At the end we pass an array of all the geometries to
<code>BufferGeometryUtils.mergeBufferGeometries</code> which will combined all of
them into a single mesh.</p>
<p>We also need to include the <code>BufferGeometryUtils</code></p>
<pre class="prettyprint"><code class="lang-js">import {BufferGeometryUtils} from &#39;./resources/threejs/r108/examples/jsm/utils/BufferGeometryUtils.js&#39;;
</code></pre>
<p>And now, at least on my machine, I get 60 frames per second</p>
<p><div class="threejs_example_container">
  <div><iframe class="threejs_example" style=" " src="/threejs/resources/editor.html?url=/threejs/lessons/..%2Fthreejs-lots-of-objects-merged.html"></iframe></div>
  <a class="threejs_center" href="/threejs/lessons/../threejs-lots-of-objects-merged.html" target="_blank">click here to open in a separate window</a>
</div>

</p>
<p>So that worked but because it&#39;s one mesh we only get one material which means we
only get one color where as before we had a different color on each box. We can
fix that by using vertex colors.</p>
<p>Vertex colors add a color per vertex. By setting all the colors of each vertex
of each box to specific colors every box will have a different color.</p>
<pre class="prettyprint"><code class="lang-js">+const color = new THREE.Color();

const lonFudge = Math.PI * .5;
const latFudge = Math.PI * -0.135;
const geometries = [];
data.forEach((row, latNdx) =&gt; {
  row.forEach((value, lonNdx) =&gt; {
    if (value === undefined) {
      return;
    }
    const amount = (value - min) / range;

    const boxWidth = 1;
    const boxHeight = 1;
    const boxDepth = 1;
    const geometry = new THREE.BoxBufferGeometry(boxWidth, boxHeight, boxDepth);

    // adjust the helpers to point to the latitude and longitude
    lonHelper.rotation.y = THREE.Math.degToRad(lonNdx + file.xllcorner) + lonFudge;
    latHelper.rotation.x = THREE.Math.degToRad(latNdx + file.yllcorner) + latFudge;

    // use the world matrix of the origin helper to
    // position this geometry
    positionHelper.scale.set(0.005, 0.005, THREE.Math.lerp(0.01, 0.5, amount));
    originHelper.updateWorldMatrix(true, false);
    geometry.applyMatrix(originHelper.matrixWorld);

+    // compute a color
+    const hue = THREE.Math.lerp(0.7, 0.3, amount);
+    const saturation = 1;
+    const lightness = THREE.Math.lerp(0.4, 1.0, amount);
+    color.setHSL(hue, saturation, lightness);
+    // get the colors as an array of values from 0 to 255
+    const rgb = color.toArray().map(v =&gt; v * 255);
+
+    // make an array to store colors for each vertex
+    const numVerts = geometry.getAttribute(&#39;position&#39;).count;
+    const itemSize = 3;  // r, g, b
+    const colors = new Uint8Array(itemSize * numVerts);
+
+    // copy the color into the colors array for each vertex
+    colors.forEach((v, ndx) =&gt; {
+      colors[ndx] = rgb[ndx % 3];
+    });
+
+    const normalized = true;
+    const colorAttrib = new THREE.BufferAttribute(colors, itemSize, normalized);
+    geometry.addAttribute(&#39;color&#39;, colorAttrib);

    geometries.push(geometry);
  });
});
</code></pre>
<p>The code above looks up the number or vertices needed by getting the <code>position</code>
attribute from the geometry. We then create a <code>Uint8Array</code> to put the colors in.
It then adds that as an attribute by calling <code>geometry.addAttribute</code>.</p>
<p>Lastly we need to tell three.js to use the vertex colors. </p>
<pre class="prettyprint"><code class="lang-js">const mergedGeometry = BufferGeometryUtils.mergeBufferGeometries(
    geometries, false);
-const material = new THREE.MeshBasicMaterial({color:&#39;red&#39;});
+const material = new THREE.MeshBasicMaterial({
+  vertexColors: THREE.VertexColors,
+});
const mesh = new THREE.Mesh(mergedGeometry, material);
scene.add(mesh);
</code></pre>
<p>And with that we get our colors back</p>
<p><div class="threejs_example_container">
  <div><iframe class="threejs_example" style=" " src="/threejs/resources/editor.html?url=/threejs/lessons/..%2Fthreejs-lots-of-objects-merged-vertexcolors.html"></iframe></div>
  <a class="threejs_center" href="/threejs/lessons/../threejs-lots-of-objects-merged-vertexcolors.html" target="_blank">click here to open in a separate window</a>
</div>

</p>
<p>Merging geometry is a common optimization technique. For example rather than
100 trees you might merge the trees into 1 geometry, a pile of individual rocks
into a single geometry of rocks, a picket fence from individual pickets into
one fence mesh. Another example in Minecraft it doesn&#39;t likely draw each cube
individually but rather creates groups of merged cubes and also selectively removing 
faces that are never visible.</p>
<p>The problem with making everything one mesh though is it&#39;s no longer easy
to move any part that was previously separate. Depending on our use case
though there are creative solutions. We&#39;ll explore one in
<a href="threejs-optimize-lots-of-objects-animated.html">another article</a>.</p>
<p><canvas id="c"></canvas></p>
<script type="module" src="resources/threejs-lots-of-objects.js"></script>
    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/threejs/lessons/threejs-optimize-lots-of-objects.html" selected>English</a>
    <option value="/threejs/lessons/ru/threejs-optimize-lots-of-objects.html" >Русский</a>
    <option value="/threejs/lessons/zh_cn/threejs-optimize-lots-of-objects.html" >中文</a>
</select>


        <div id="toc">
          <ul>  <li>Basics</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-fundamentals.html">Fundamentals</a></li>
<li><a href="/threejs/lessons/threejs-responsive.html">Responsive Design</a></li>
<li><a href="/threejs/lessons/threejs-prerequisites.html">Prerequisites</a></li>
<li><a href="/threejs/lessons/threejs-setup.html">Setup</a></li>
        </ul>
  <li>Solutions</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-load-obj.html">Load an .OBJ file</a></li>
<li><a href="/threejs/lessons/threejs-load-gltf.html">Load a .GLTF file</a></li>
<li><a href="/threejs/lessons/threejs-backgrounds.html">Add a Background or Skybox</a></li>
<li><a href="/threejs/lessons/threejs-transparency.html">How to Draw Transparent Objects</a></li>
<li><a href="/threejs/lessons/threejs-multiple-scenes.html">Multiple Canvases, Multiple Scenes</a></li>
<li><a href="/threejs/lessons/threejs-picking.html">Picking Objects with the mouse</a></li>
<li><a href="/threejs/lessons/threejs-post-processing.html">Post Processing</a></li>
<li><a href="/threejs/lessons/threejs-post-processing-3dlut.html">Applying a LUT File for effects</a></li>
<li><a href="/threejs/lessons/threejs-shadertoy.html">Using Shadertoy shaders</a></li>
<li><a href="/threejs/lessons/threejs-align-html-elements-to-3d.html">Aligning HTML Elements to 3D</a></li>
<li><a href="/threejs/lessons/threejs-indexed-textures.html">Using Indexed Textures for Picking and Color</a></li>
<li><a href="/threejs/lessons/threejs-canvas-textures.html">Using A Canvas for Dynamic Textures</a></li>
<li><a href="/threejs/lessons/threejs-billboards.html">Billboards and Facades</a></li>
<li><a href="/threejs/lessons/threejs-cleanup.html">Freeing Resources</a></li>
<li><a href="/threejs/lessons/threejs-voxel-geometry.html">Making Voxel Geometry (Minecraft)</a></li>
<li><a href="/threejs/lessons/threejs-game.html">Start making a Game.</a></li>
        </ul>
  <li>WebVR</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-webvr.html">WebVR - Basics</a></li>
<li><a href="/threejs/lessons/threejs-webvr-look-to-select.html">WebVR - Look To Select</a></li>
<li><a href="/threejs/lessons/threejs-webvr-point-to-select.html">WebVR - Point To Select</a></li>
        </ul>
  <li>Optimization</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-optimize-lots-of-objects.html">Optimizing Lots of Objects</a></li>
<li><a href="/threejs/lessons/threejs-optimize-lots-of-objects-animated.html">Optimizing Lots of Objects Animated</a></li>
<li><a href="/threejs/lessons/threejs-offscreencanvas.html">Using OffscreenCanvas in a Web Worker</a></li>
        </ul>
  <li>Tips</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-rendering-on-demand.html">Rendering On Demand</a></li>
<li><a href="/threejs/lessons/threejs-debugging-javascript.html">Debugging JavaScript</a></li>
<li><a href="/threejs/lessons/threejs-debugging-glsl.html">Debugging GLSL</a></li>
<li><a href="/threejs/lessons/threejs-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/threejs/lessons/threejs-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/threejs/lessons/threejs-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/threejs/lessons/threejs-tips.html#transparent-canvas">Make the Canvas Transparent</a></li>
<li><a href="/threejs/lessons/threejs-tips.html#html-background">Use three.js as Background in HTML</a></li>
        </ul>
  <li>Fundamentals</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-primitives.html">Primitives</a></li>
<li><a href="/threejs/lessons/threejs-scenegraph.html">Scenegraph</a></li>
<li><a href="/threejs/lessons/threejs-materials.html">Materials</a></li>
<li><a href="/threejs/lessons/threejs-textures.html">Textures</a></li>
<li><a href="/threejs/lessons/threejs-lights.html">Lights</a></li>
<li><a href="/threejs/lessons/threejs-cameras.html">Cameras</a></li>
<li><a href="/threejs/lessons/threejs-shadows.html">Shadows</a></li>
<li><a href="/threejs/lessons/threejs-fog.html">Fog</a></li>
<li><a href="/threejs/lessons/threejs-rendertargets.html">Render Targets</a></li>
<li><a href="/threejs/lessons/threejs-custom-geometry.html">Custom Geometry</a></li>
<li><a href="/threejs/lessons/threejs-custom-buffergeometry.html">Custom BufferGeometry</a></li>
        </ul>
  <li>Reference</li>
        <ul>
          <li><a href="/threejs/lessons/threejs-material-table.html">Material Table</a></li>
        </ul></ul>
<ul>
  <li><a href="https://github.com/gfxfundamentals/threejsfundamentals">github</a></li>
  <li><a href="https://threejs.org">three.js</a></li>
  <li><a href="https://threejs.org/docs/">three.js docs</a></li>
</ul>

        </div>
    </div>
    <div class="lesson-comments">
        <div>Questions? <a href="http://stackoverflow.com/questions/tagged/three.js">Ask on stackoverflow</a>.</div>
        <div><a href="https://github.com/gfxfundamentals/threejsfundamentals/issues/new?assignees=&labels=suggested+topic&template=suggest-topic.md&title=%5BSUGGESTION%5D">Suggestion</a>? <a href="https://github.com/gfxfundamentals/threejsfundamentals/issues/new?assignees=&labels=&template=request.md&title=">Request</a>? <a href="https://github.com/gfxfundamentals/threejsfundamentals/issues/new?assignees=&labels=bug+%2F+issue&template=bug-issue-report.md&title=">Issue</a>? <a href="https://github.com/gfxfundamentals/threejsfundamentals/issues/new?assignees=&labels=bug+%2F+issue&template=bug-issue-report.md&title=">Bug</a>?</div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'threejsfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'Three.js Optimize Lots of Objects';
            var disqus_title = 'Three.js Optimize Lots of Objects';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("threejsfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-3.3.1.slim.min.js"></script>
<script src="/threejs/lessons/resources/prettify.js"></script>
<script src="/threejs/lessons/resources/lesson.js"></script>
<script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120733518-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120733518-1');
</script>


</html>



